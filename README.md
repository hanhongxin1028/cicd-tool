# CICD Tool

ä¸€æ¬¾ CI/CD è‡ªåŠ¨åŒ–å·¥å…·ï¼ŒåŸºäº Python å¼€å‘ã€‚é€šè¿‡ç®€å•çš„å‘½ä»¤è¡Œæ“ä½œï¼Œå®ç°ä»åˆ†æ”¯ç®¡ç†ã€ä»£ç æ¨é€åˆ°è¿œç¨‹éƒ¨ç½²çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
cicd_tool/
â”œâ”€â”€ pyproject.toml           # é¡¹ç›®é…ç½®ä¸ä¾èµ–å®šä¹‰
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ src/cicd/
    â”œâ”€â”€ client/              # ğŸ–¥ï¸  å¼€å‘è€…æœ¬åœ°ä½¿ç”¨
    â”‚   â”œâ”€â”€ cli.py           # CLI ä¸»å…¥å£
    â”‚   â””â”€â”€ commands/
    â”‚       â”œâ”€â”€ cmd_init.py       # init å‘½ä»¤ï¼šé¡¹ç›®åˆå§‹åŒ–
    â”‚       â”œâ”€â”€ cmd_preparedev.py # preparedev å‘½ä»¤ï¼šåˆ†æ”¯åˆ›å»º
    â”‚       â””â”€â”€ cmd_deploy.py     # deploy å‘½ä»¤ï¼šè§¦å‘éƒ¨ç½²
    â”‚
    â”œâ”€â”€ server/              # ğŸ–§  éƒ¨ç½²æœåŠ¡å™¨ä½¿ç”¨
    â”‚   â”œâ”€â”€ runner.py        # Runner ä¸»å…¥å£
    â”‚   â”œâ”€â”€ commands/
    â”‚   â”‚   â””â”€â”€ cmd_deploy.py    # æœåŠ¡ç«¯éƒ¨ç½²æ‰§è¡Œé€»è¾‘
    â”‚   â”œâ”€â”€ actions/
    â”‚   â”‚   â””â”€â”€ nginx.py         # Nginx é…ç½®é‡è½½ Action
    â”‚   â””â”€â”€ utils/
    â”‚       â””â”€â”€ executor.py      # Step æ‰§è¡Œå™¨
    â”‚
    â””â”€â”€ common/              # ğŸ”§ å…¬å…±æ¨¡å—
        â”œâ”€â”€ config_ops.py    # é…ç½®æ–‡ä»¶æ“ä½œ
        â”œâ”€â”€ git_ops.py       # Git å‘½ä»¤å°è£…
        â”œâ”€â”€ ssh_ops.py       # SSH è¿œç¨‹æ‰§è¡Œ
        â””â”€â”€ logger.py        # æ—¥å¿—å·¥å…·
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ Client-Server æ¶æ„

| ç»„ä»¶ | å‘½ä»¤ | å®‰è£…ä½ç½® | èŒè´£ |
|------|------|----------|------|
| **Client** | `cicd` | å¼€å‘è€…æœ¬åœ° | åˆ†æ”¯ç®¡ç†ã€ä»£ç æ¨é€ã€è§¦å‘éƒ¨ç½² |
| **Server** | `cicd-runner` | éƒ¨ç½²æœåŠ¡å™¨ | æ‹‰å–ä»£ç ã€æ‰§è¡Œæ„å»ºã€éƒ¨ç½²äº§ç‰© |

### ğŸš€ å®¢æˆ·ç«¯å‘½ä»¤

| å‘½ä»¤ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `cicd init` | é¡¹ç›®åˆå§‹åŒ– | æ£€æŸ¥ Git ä»“åº“ã€åˆ›å»ºé…ç½®æ–‡ä»¶ |
| `cicd preparedev` | å¼€å§‹æ–°ä»»åŠ¡ | äº¤äº’å¼åˆ›å»º feature/fix åˆ†æ”¯ |
| `cicd deploy` | éƒ¨ç½²å‘å¸ƒ | æ¨é€ä»£ç å¹¶è§¦å‘è¿œç¨‹éƒ¨ç½² |

### ğŸ”§ æœåŠ¡ç«¯å‘½ä»¤

| å‘½ä»¤ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `cicd-runner deploy` | æ‰§è¡Œéƒ¨ç½² | æ‹‰å–ä»£ç ã€æ‰§è¡Œæ„å»ºæ­¥éª¤ |

## ğŸ“¦ å®‰è£…éƒ¨ç½²

### ç¯å¢ƒè¦æ±‚

- Python >= 3.10
- Git
- SSH å¯†é’¥é…ç½® (å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨å…å¯†ç™»å½•)

### å¼€å‘è€…æœ¬åœ°å‘½åè£…é…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repo-url> cicd_tool
cd cicd_tool

# 2. å®‰è£…ä¾èµ–
pip install -e ".[client]"

# 3. éªŒè¯å®‰è£…
cicd --help
```

### éƒ¨ç½²æœåŠ¡å™¨å‘½åè£…é…

```bash
# 1. å…‹éš†é¡¹ç›®åˆ°æœåŠ¡å™¨
git clone <repo-url> /opt/cicd_tool
cd /opt/cicd_tool

# 2. å®‰è£…ä¾èµ–
pip install -e ".[server]"

# 4. éªŒè¯å®‰è£…
cicd-runner --help
```

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### 1. åˆå§‹åŒ–é¡¹ç›®

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
cicd init
```

è¿™å°†ï¼š
- âœ… æ£€æŸ¥æ˜¯å¦ä¸º Git ä»“åº“
- âœ… æ£€æŸ¥è¿œç¨‹ä»“åº“å…³è”
- âœ… åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ `cicd-config.yaml`

### 2. é…ç½®æ–‡ä»¶

ç¼–è¾‘é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `cicd-config.yaml`ï¼š

```yaml
# é¡¹ç›®åç§°
project_name: "my-project"

# æœåŠ¡å™¨é…ç½®
server:
  host: "192.168.1.100"           # æœåŠ¡å™¨ IP
  user: "deploy"                   # SSH ç”¨æˆ·å
  port: 22                         # SSH ç«¯å£
  repo_path: "/data/repos/my-project"  # æœåŠ¡å™¨ä»£ç ç›®å½•

# ç¯å¢ƒé…ç½®
environments:
  # ç”Ÿäº§ç¯å¢ƒ
  prod:
    deploy_path: "/apps/my-project/"
    steps:
      - "npm install"
      - "npm run build:prod"
      - "rm -rf {deploy_path}/*"
      - "cp -r dist/* {deploy_path}"
      - action: nginx

  # å¼€å‘ç¯å¢ƒ
  dev:
    deploy_path: "/data/repos/my-project/dist"
    steps:
      - "npm install"
      - "npm run build:dev"
```

### 3. å¼€å§‹æ–°åŠŸèƒ½å¼€å‘

```bash
cicd preparedev
```

äº¤äº’å¼å‘å¯¼å°†å¼•å¯¼ä½ ï¼š
1. é€‰æ‹©åˆ†æ”¯ç±»å‹ (feat/fix/hotfix/chore)
2. è¾“å…¥ä»»åŠ¡åç§°
3. è‡ªåŠ¨åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯

### 4. éƒ¨ç½²å‘å¸ƒ

```bash
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ (é»˜è®¤)
cicd deploy

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
cicd deploy --env prod
```

## ğŸ” SSH å…å¯†é…ç½®

å®¢æˆ·ç«¯éœ€è¦é…ç½®åˆ°æœåŠ¡å™¨çš„ SSH å…å¯†ç™»å½•ï¼š

```bash
# 1. ç”Ÿæˆ SSH å¯†é’¥ (å¦‚æœè¿˜æ²¡æœ‰)
ssh-keygen -t rsa -b 4096

# 2. å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id user@server_ip

# 3. æµ‹è¯•å…å¯†ç™»å½•
ssh user@server_ip
```

## ğŸ“‹ ä¾èµ–è¯´æ˜

### æ ¸å¿ƒä¾èµ–

| åŒ…å | ç”¨é€” |
|------|------|
| typer | ç°ä»£åŒ– CLI æ¡†æ¶ |
| rich | ç»ˆç«¯ç¾åŒ–è¾“å‡º |
| pyyaml | YAML é…ç½®è§£æ |
| python-dotenv | ç¯å¢ƒå˜é‡ç®¡ç† |

### å®¢æˆ·ç«¯ä¸“ç”¨

| åŒ…å | ç”¨é€” |
|------|------|
| inquirerpy | äº¤äº’å¼å‘½ä»¤è¡Œå‘å¯¼ |
| paramiko | SSH å®¢æˆ·ç«¯è¿æ¥ |
| scp | æ–‡ä»¶ä¼ è¾“ |

